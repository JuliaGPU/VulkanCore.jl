# Based on https://github.com/vsg-dev/VulkanSceneGraph/blob/master/.github/workflows/ci.yml
name: CI
on:
  push:
  pull_request:
env:
  JuliaVersion: 1.5
  VulkanSDKVersion: 1.2.148.1
  JULIA_GITHUB_ACTIONS_CI: ON
jobs:
  # ubuntu-latest-x64:
  #   runs-on: ubuntu-latest
  #   env:
  #     VULKAN_SDK: $GITHUB_WORKSPACE/../$VulkanSDKVersion/x86_64
  #   steps:
  #   - uses: actions/checkout@v2
  #   - name: Download & Extract Vulkan SDK
  #     run: |
  #       wget --no-cookies -O ../vulkansdk-linux-x86_64-${{env.VulkanSDKVersion}}.tar.gz https://sdk.lunarg.com/sdk/download/${{env.VulkanSDKVersion}}/linux/vulkansdk-linux-x86_64-${{env.VulkanSDKVersion}}.tar.gz?u=
  #       tar -zxf ../vulkansdk-linux-x86_64-${{env.VulkanSDKVersion}}.tar.gz -C ../
  #   - name: Install xvfb for GLFW
  #     run: sudo apt-get install xvfb && Xvfb :99 &
  #   - uses: julia-actions/setup-julia@v1
  #     with:
  #       version: ${{env.JuliaVersion}}
  #       arch: x64
  #   - uses: julia-actions/julia-buildpkg@latest
  #   - uses: julia-actions/julia-runtest@latest
  #     env:
  #       DISPLAY: :99
  #   - uses: julia-actions/julia-uploadcodecov@latest
  #     env:
  #       CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # windows-latest-x64:
  #   runs-on: windows-latest
  #   steps:
  #   - uses: actions/checkout@v2
  #   - name: Set Environment variables
  #     run: echo "VULKAN_SDK=C:\VulkanSDK\${{env.VulkanSDKVersion}}" >> $GITHUB_ENV
  #   - name: Download & Install Vulkan SDK
  #     run: |
  #       Invoke-WebRequest -Uri https://sdk.lunarg.com/sdk/download/${{env.VulkanSDKVersion}}/windows/VulkanSDK-${{env.VulkanSDKVersion}}-Installer.exe?u= -OutFile ../vulkan-sdk-${{env.VulkanSDKVersion}}.exe
  #       $installer = Start-Process -FilePath ../vulkan-sdk-${{env.VulkanSDKVersion}}.exe -Wait -PassThru -ArgumentList @("/S");
  #       $installer.WaitForExit(); 
  #       Invoke-WebRequest -Uri https://sdk.lunarg.com/sdk/download/latest/windows/vulkan-runtime.exe -OutFile ../vulkan-runtime.exe
  #       $installer = Start-Process -FilePath ../vulkan-runtime.exe -Wait -PassThru -ArgumentList @("/S");
  #       $installer.WaitForExit();
  #   - uses: julia-actions/setup-julia@v1
  #     with:
  #       version: ${{env.JuliaVersion}}
  #       arch: x64
  #   - uses: julia-actions/julia-buildpkg@latest
  #   - uses: julia-actions/julia-runtest@latest
  #     env:
  #       DISPLAY: :99
  #   - uses: julia-actions/julia-uploadcodecov@latest
  #     env:
  #       CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  macos-latest-x64:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v2
    - name: Download & Extract Vulkan SDK
      run: |
        wget --no-cookies -O $GITHUB_WORKSPACE/../vulkansdk-macos-${{env.VulkanSDKVersion}}.dmg https://sdk.lunarg.com/sdk/download/${{env.VulkanSDKVersion}}/mac/vulkansdk-macos-${{env.VulkanSDKVersion}}.dmg?u=
        hdiutil attach $GITHUB_WORKSPACE/../vulkansdk-macos-${{env.VulkanSDKVersion}}.dmg
    - uses: julia-actions/setup-julia@v1
      with:
        version: ${{env.JuliaVersion}}
        arch: x64
    - uses: julia-actions/julia-buildpkg@latest
    - uses: julia-actions/julia-runtest@latest
      env:
        DYLD_LIBRARY_PATH: "/Volumes/vulkansdk-macos-${{env.VulkanSDKVersion}}/macOS/lib"
        VK_LAYER_PATH: "/Volumes/vulkansdk-macos-${{env.VulkanSDKVersion}}/macOS/share/vulkan/explicit_layer.d"
        VK_ICD_FILENAMES: "/Volumes/vulkansdk-macos-${{env.VulkanSDKVersion}}/macOS/share/vulkan/icd.d/MoltenVK_icd.json"
        DISPLAY: :99
    - uses: julia-actions/julia-uploadcodecov@latest
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
    - name: Detach Volume
      run: | 
        hdiutil detach /Volumes/vulkansdk-macos-${{env.VulkanSDKVersion}}
